@using PTS.Infrastructure;

<br />
<div class="row">

    <div class="form-group">
        <div class="col-md-4">
            <input id="globalSearch" class="form-control" style="font-size: 20px;" />
        </div>
        <div class="col-md-2">
            <button id="globalSearchButton" class="btn btn-primary" float: right>Search</button>
        </div>
        <div class="col-md-4">
            <input id="searchZipCode" placeholder="Zip Code" class="form-control" style="font-size: 20px;" />
         </div>
        <div class="col-md-2">
            <button id="applyZipCodeFilter" class="btn btn-primary">Apply</button>
         </div>
    </div>
</div>

<div class="row">
    
</div>

        

<br />
<div id="teacherUserTable"></div>
<br />
<br />
<div id="classesTable"></div>

<script>
    var lat1 = '@(SessionDataHelper.Latitude)';
    var lon1 = '@(SessionDataHelper.Longitude)';

    function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
        var R = 6371; // Radius of the earth in km
        var dLat = deg2rad(lat2 - lat1);  // deg2rad below
        var dLon = deg2rad(lon2 - lon1);
        var a =
          Math.sin(dLat / 2) * Math.sin(dLat / 2) +
          Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
          Math.sin(dLon / 2) * Math.sin(dLon / 2)
        ;
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        var d = R * c; // Distance in km
        return d;
    }

    function deg2rad(deg) {
        return deg * (Math.PI / 180)
    }
    $(document).ready(function () {
        $('#globalSearchButton').on('click', function (event) {
            $('#teacherUserTable').jtable('load', JSON.stringify({
                textSearch: $('#globalSearch').val()
            }));
            $('#classesTable').jtable('load', JSON.stringify({
                textSearch: $('#globalSearch').val()
            }));
        });
        $('#globalSearch').keypress(function (e) {
           if (e.which == 13) {
               $('#globalSearchButton').focus().click();
            }
        });

        $('#teacherUserTable').jtable({
            title: 'Tutors',
            openChildAsAccordion: true,
            paging: true,
            pageSize: 10,
            ajaxSettings: {
                contentType: 'application/json'
        	},
            actions: {
                listAction: '@Url.Action("GetTeacherUsers")',
                
            },
            fields: {
                Id: {
                    key: true,
                    list: false,
                    create: false,
                    edit: false,
                },
                FirstName: {
                    title: 'First Name',
                },
                LastName: {
                    title: 'Last Name'
                },
                Email: {
                    title: 'Email',
                },
                AverageRating: {
                    title: 'Ratings',
                    display: function (data) {
                        if (data.record.AverageRating != "No Ratings") {
                            return '<a href="@Url.Action("ReviewTeacherView", "Review")?teacherId=' + data.record.Id + '">' + data.record.AverageRating + ' / 10</a>';
                        }
                        else {
                            return data.record.AverageRating;
                        }
                    }
                },
                ClassRate: {
                    title: 'Class Rate'
                },
                HourlyRate: {
                    title: 'Hourly Rate'
                },
                Availability: {
                    title: 'Availability',
                    sorting: false,
                    display: function (tutorData) {
                        var link = $('<a>Availibility</a>');
                        link.click(function () {

                            $('#teacherUserTable').jtable('openChildTable',
                                link.closest('tr'),
                                {
                                    title: 'Availibility for ' + tutorData.record.FirstName + " " + tutorData.record.LastName,
                                    actions: {
                                        listAction: '@Url.Action("GetTutorAvailibility")',
                                    },
                                    fields: {
                                        Id: {
                                            type: 'hidden',
                                            defaultValue: tutorData.record.Id
                                        },
                                        ScheduleId: {
                                            key: true,
                                            list: false,
                                        },
                                        Sunday: {
                                            title: 'Sunday',
                                        },
                                        Monday: {
                                            title: 'Monday'
                                        },
                                        Tuesday: {
                                            title: 'Tuesday'
                                        },
                                        Wednesday: {
                                            title: 'Wednesday'
                                        },
                                        Thursday: {
                                            title: 'Thursday'
                                        },
                                        Friday: {
                                            title: 'Friday'
                                        },
                                        Saturday: {
                                            title: 'Saturday'
                                        },

                                    }
                                }, function (innerData) {
                                    innerData.childTable.jtable('load', {
                                        tutorUserId: tutorData.record.Id
                                    });
                                });
                        });
                        return link;
                    }
                },
                RequestAppointment: {
                    title: 'Request Session',
                    display: function (data) {
                        return '<a href="@Url.Action("LoadRequestSession", "Account")?teacherId=' + data.record.Id + '">Request Session</a>';
                    }
                },
                Map: {
                    title: 'Map',
                    display: function (data) {
                        return '<a href="@Url.Action("LoadTeacherMap")?teacherId=' + data.record.Id + '">Map</a>';
                    }
                }
            }
        }).jtable('load');

       

        var toolbarItems = [{
            text: 'Enroll',
            click: function() {
                var selectedRow = $('#classesTable').jtable('selectedRows').data('record');
                console.log(selectedRow.Id + " HEREER ");
                if (selectedRow) {
                    window.location.href = '@Url.Action("ProcessPayment", "Payment")?classId=' + selectedRow.Id;
                }
            },
        }];
        
        $('#classesTable').jtable({
            title: 'Classes',
            selecting: true,
            multiselect: false,
            selectingCheckboxes: true,
            paging: true,
            pageSize: 10,
            toolbar: {
                items: toolbarItems
            },
            ajaxSettings: {
                contentType: 'application/json'
            },
            actions: {
                listAction: '@Url.Action("GetClasses")',
            },
            fields: {
                Id: {
                    key: true,
                    list: false,
                    create: false,
                    edit: false,
                },
                SubjectId: {
                    list: false,
                    create: false,
                    edit: false,
                },
                LocationId: {
                    list: false,
                    create: false,
                    edit: false,
                },
                Description: {
                    title: 'Description',
                },
                TeacherName: {
                    title: 'Teacher',
                },
                SubjectName:{
                    title: 'Subject'
                },
                AverageRating: {
                    title: 'Ratings',
                    display: function (data) {
                        if (data.record.AverageRating != "No Ratings") {
                            return '<a href="@Url.Action("ReviewClassesView", "Review")?classId=' + data.record.Id + '">' + data.record.AverageRating + ' / 10</a>';
                        }
                        else {
                            return data.record.AverageRating;
                        }
                    }
                },
                StartTime: {
                    title: 'Start Time',
                },
                EndTime: {
                    title: 'End Time',
                },
                Duration: {
                    title: 'Duration',
                },
                Address: {
                    title: 'Address'
                },
                City: {
                    title: 'City'
                },
                State: {
                    title: 'State'
                },
                ZipCode: {
                    title: 'Zip Code'
                },
                Country: {
                    title: 'Country'
                }

            },
        }).jtable('load');

    });


    
</script>

